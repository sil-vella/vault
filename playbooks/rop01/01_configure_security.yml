---
- name: Configure Vault server with security best practices
  hosts: "{{ vm_name }}_public"
  become: true
  become_method: sudo
  tasks:
    - name: Handle package manager locks
      block:
        - name: Remove package manager locks
          file:
            path: "{{ item }}"
            state: absent
          with_items:
            - /var/lib/dpkg/lock-frontend
            - /var/lib/dpkg/lock
          ignore_errors: yes

        - name: Reconfigure dpkg
          command: dpkg --configure -a
          ignore_errors: yes

    - name: Get current time
      command: date +%s
      register: current_time
      changed_when: false

    - name: Set time back by 20 minutes
      command: date -s "@{{ (current_time.stdout | int) - 1200 }}"
      changed_when: true

    - name: Install ntpdate
      apt:
        name: ntpdate
        state: present
        update_cache: yes

    - name: Sync time with NTP servers
      command: ntpdate pool.ntp.org
      changed_when: false
      ignore_errors: true

    - name: Update and upgrade all packages
      apt:
        update_cache: yes
        upgrade: dist
        force_apt_get: yes

    - name: Install essential software
      apt:
        name:
          - fail2ban
          - apparmor
          - apparmor-profiles
          - auditd
          - libpam-pwquality
          - openssh-server
          - unattended-upgrades
          - apt-listchanges
          - nano
          - wget
          - curl
          - zip
          - unzip
          - git
          - software-properties-common
          - rsync
          - iptables-persistent
        state: present
        update_cache: yes

    - name: Ensure AppArmor is running
      service:
        name: apparmor
        state: started
        enabled: yes

    - name: Ensure Fail2Ban is running
      service:
        name: fail2ban
        state: started
        enabled: yes

    - name: Restore correct time
      command: ntpdate pool.ntp.org
      changed_when: false
      ignore_errors: true

